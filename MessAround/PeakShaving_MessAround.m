% Peak shaving Messaround
%
% Looking into implementing a peak shaving method using Ct tables


%% Read Cp_Ct_Cq.txt

filename = ('/Users/nabbas/Documents/WindEnergyToolbox/WTC_toolbox/examples/Cp_Ct_Cq.txt') % for NREL 5MW
fid = fopen(filename);

line = fgetl(fid);
while ~feof(fid)
    if contains(line,'Pitch angle')
        line = fgetl(fid);
        BlPitch = str2num(line);
    elseif contains(line,'TSR')
        line = fgetl(fid);
        TSR = str2num(line);
    elseif contains(line, 'Power')
        line = fgetl(fid);
        for i = 1:length(TSR)
            line = fgetl(fid);
            Cp(i,:) = str2num(line);
        end
    elseif contains(line, 'Thrust')
        line = fgetl(fid);
        for i = 1:length(TSR)
            line = fgetl(fid);
            Ct(i,:) = str2num(line);
        end
    elseif contains(line, 'Torque')
        line = fgetl(fid);
        for i = 1:length(TSR)
            line = fgetl(fid);
            Cq(i,:) = str2num(line);
        end
    end
    line = fgetl(fid);
end

fclose(fid);

%% Load turbine data - run Pre_ContParam_TSR_NREL5MW;
rho = ContParam.rho;
A = ContParam.RotorRad^2 * pi;

%% Find and plot Original Thrust
Beta_op = [0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0        0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0         0    0.0202    0.0313    0.0404    0.0482    0.0552    0.0616    0.0676    0.0732    0.0786    0.0836    0.0884    0.0931    0.0977    0.1021    0.1063    0.1104    0.1144    0.1184    0.1223    0.1260    0.1297    0.1333    0.1369    0.1404    0.1439    0.1472    0.1505    0.1538    0.1571    0.1603    0.1635    0.1666    0.1696    0.1726    0.1756    0.1786    0.1816    0.1846    0.1874    0.1903    0.1931    0.1959    0.1987    0.2015    0.2043    0.2070    0.2097    0.2123    0.2150    0.2176    0.2203    0.2229    0.2256    0.2282    0.2307    0.2332    0.2356    0.2380    0.2405    0.2429    0.2453    0.2478    0.2502    0.2525    0.2548    0.2571    0.2594    0.2616    0.2639    0.2662    0.2685    0.2709    0.2732    0.2755    0.2776    0.2797    0.2819    0.2840    0.2862    0.2884    0.2906    0.2928    0.2950    0.2972    0.2995    0.3016    0.3036    0.3057    0.3077    0.3098    0.3119    0.3140    0.3161    0.3182    0.3203    0.3224    0.3246    0.3267    0.3288    0.3308    0.3328    0.3347    0.3367    0.3387    0.3406    0.3426    0.3446    0.3466    0.3486    0.3506    0.3527    0.3548    0.3568    0.3589    0.3608    0.3626    0.3644    0.3662    0.3681    0.3699    0.3718    0.3737    0.3756    0.3775    0.3794    0.3813    0.3833    0.3852    0.3872    0.3891    0.3911    0.3930    0.3947    0.3964    0.3981    0.3998];
Beta_op = Beta_op * 180/pi;
TSR_op =    [7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.5000    7.0024    6.9416    6.8817    6.8229    6.7651    6.7082    6.6523    6.5973    6.5433    6.4901    6.4377    6.3862    6.3355    6.2857    6.2366    6.1882    6.1406    6.0937    6.0476    6.0021    5.9573    5.9132    5.8697    5.8269    5.7846    5.7430    5.7020    5.6616    5.6217    5.5824    5.5436    5.5054    5.4677    5.4305    5.3938    5.3576    5.3219    5.2866    5.2518    5.2175    5.1836    5.1502    5.1172    5.0846    5.0524    5.0206    4.9892    4.9583    4.9276    4.8974    4.8676    4.8381    4.8089    4.7801    4.7517    4.7235    4.6958    4.6683    4.6412    4.6143    4.5878    4.5616    4.5357    4.5100    4.4847    4.4597    4.4349    4.4104    4.3861    4.3622    4.3385    4.3150    4.2918    4.2689    4.2462    4.2237    4.2015    4.1795    4.1577    4.1362    4.1148    4.0937    4.0729    4.0522    4.0317    4.0115    3.9914    3.9715    3.9519    3.9324    3.9131    3.8940    3.8751    3.8564    3.8379    3.8195    3.8013    3.7833    3.7655    3.7478    3.7303    3.7129    3.6957    3.6787    3.6618    3.6451    3.6285    3.6121    3.5958    3.5797    3.5637    3.5479    3.5322    3.5166    3.5012    3.4859    3.4708    3.4558    3.4409    3.4261    3.4114    3.3969    3.3825    3.3683    3.3541    3.3401    3.3262    3.3124    3.2987    3.2851    3.2716    3.2583    3.2450    3.2319    3.2189    3.2059    3.1931];
v = [3.0000    3.1000    3.2000    3.3000    3.4000    3.5000    3.6000    3.7000    3.8000    3.9000    4.0000    4.1000    4.2000    4.3000    4.4000    4.5000    4.6000    4.7000    4.8000    4.9000    5.0000    5.1000    5.2000    5.3000    5.4000    5.5000    5.6000    5.7000    5.8000    5.9000    6.0000    6.1000    6.2000    6.3000    6.4000    6.5000    6.6000    6.7000    6.8000    6.9000    7.0000    7.1000    7.2000    7.3000    7.4000    7.5000    7.6000    7.7000    7.8000    7.9000    8.0000    8.1000    8.2000    8.3000    8.4000    8.5000    8.6000    8.7000    8.8000    8.9000    9.0000    9.1000    9.2000    9.3000    9.4000    9.5000    9.6000    9.7000    9.8000    9.9000   10.0000   10.1000   10.2000   10.3000   10.4000   10.5000   10.6000   10.7000   10.8000   10.9000   11.0000   11.1000   11.2000   11.3000   11.4000   11.4000   11.5000   11.6000   11.7000   11.8000   11.9000   12.0000   12.1000   12.2000   12.3000   12.4000   12.5000   12.6000   12.7000   12.8000   12.9000   13.0000   13.1000   13.2000   13.3000   13.4000   13.5000   13.6000   13.7000   13.8000   13.9000   14.0000   14.1000   14.2000   14.3000   14.4000   14.5000   14.6000   14.7000   14.8000   14.9000   15.0000   15.1000   15.2000   15.3000   15.4000   15.5000   15.6000   15.7000   15.8000   15.9000   16.0000   16.1000   16.2000   16.3000   16.4000   16.5000   16.6000   16.7000   16.8000   16.9000   17.0000   17.1000   17.2000   17.3000   17.4000   17.5000   17.6000   17.7000   17.8000   17.9000   18.0000   18.1000   18.2000   18.3000   18.4000   18.5000   18.6000   18.7000   18.8000   18.9000   19.0000   19.1000   19.2000   19.3000   19.4000   19.5000   19.6000   19.7000   19.8000   19.9000   20.0000   20.1000   20.2000   20.3000   20.4000   20.5000   20.6000   20.7000   20.8000   20.9000   21.0000   21.1000   21.2000   21.3000   21.4000   21.5000   21.6000   21.7000   21.8000   21.9000   22.0000   22.1000   22.2000   22.3000   22.4000   22.5000   22.6000   22.7000   22.8000   22.9000   23.0000   23.1000   23.2000   23.3000   23.4000   23.5000   23.6000   23.7000   23.8000   23.9000   24.0000   24.1000   24.2000   24.3000   24.4000   24.5000   24.6000   24.7000   24.8000   24.9000   25.0000];

Ct_op = interp2(BlPitch, TSR, Ct, Beta_op, TSR_op);
T = 0.5 * rho * A .*v.^2 .*Ct_op;

figure(1);
myplot(v,T);

%% Define minimum blade pitch
Tmax = 0.75 * max(T);

Beta_min = Beta_op;
for i = 1:length(T)
    if T(i) > Tmax
        Ct_tsr = interp2(BlPitch, TSR, Ct, BlPitch, TSR_op(i));
        Ct_max = Tmax/(0.5 * rho * A * v(i)^2);
        Beta_min(i) = interp1(Ct_tsr,BlPitch,Ct_max);
    end
end









